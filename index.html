<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø¯ÙˆØ§Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© - Ù…ØªÙ‚Ø¯Ù… (Firebase Realtime)</title>
  <style>
    /* (Ù†ÙØ³ Ø§Ù„Ù€CSS Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚) */
    :root {
      --main-color: #5b50a3;
      --main-dark: #3a3266;
      --secondary-color: #6c757d;
      --bg-color: #f0f2f5;
      --text-color: #333;
      --card-bg: #ffffff;
      --border-color: #e0e0e0;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    }
    body.dark-mode {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --card-bg: #1e1e1e;
      --border-color: #3a3a3a;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      color: var(--text-color);
    }
    body.dark-mode header { background-color: #1f1f1f; }
    body.dark-mode h2 { border-bottom-color: #9287cc; color: #9287cc; }
    body.dark-mode .stat-card { background-color: #2c2c2c; }
    body.dark-mode table, body.dark-mode th, body.dark-mode td { border-color: #3a3a3a; }
    body.dark-mode tbody tr:nth-child(even) { background-color: #252525; }
    body.dark-mode tbody tr:hover { background-color: #3a3a3a; }

    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--bg-color);
      direction: rtl;
      text-align: right;
      margin: 0;
      padding: 0;
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }
    main {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 15px;
      box-shadow: var(--shadow);
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    header {
      text-align: center;
      padding: 30px 0;
      background-color: var(--main-color);
      color: white;
      border-radius: 15px 15px 0 0;
      margin: -20px -20px 20px -20px;
    }
    h2 {
      color: var(--main-dark);
      border-bottom: 3px solid var(--main-color);
      display: inline-block;
      padding-bottom: 5px;
      margin-top: 30px;
      margin-bottom: 20px;
      font-size: 1.8em;
      transition: color 0.3s, border-bottom-color 0.3s;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
      justify-content: center;
    }
    .stat-card {
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      text-align: center;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .stat-card h3 { color: var(--main-color); margin-top: 0; }
    .stat-card p { font-size: 2.5em; font-weight: bold; color: var(--text-color); }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px 15px; border: 1px solid var(--border-color); text-align: center; }
    thead th { background-color: var(--main-color); color: white; font-weight: bold; }
    tbody tr:nth-child(even) { background-color: var(--bg-color); }
    tbody tr:hover { background-color: #ebe7ff; }
    input[type="checkbox"] { transform: scale(1.3); cursor: pointer; accent-color: #28a745; }
    .locked-checkbox { opacity: 0.5; cursor: not-allowed !important; background-color: #f7f7f7 !important; }
    body.dark-mode .locked-checkbox { background-color: #2c2c2c !important; }
    .status-completed { color: #28a745; font-weight: bold; }
    .status-partial { color: #ffc107; font-weight: bold; }
    .status-absent { color: #dc3545; font-weight: bold; }
    .payment-section th { background-color: var(--secondary-color); }
    .paid-row { background-color: #d4edda !important; }
    .payment-input-group { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end; flex-wrap: wrap; }
    .payment-input-group input, .payment-input-group select, .payment-input-group button {
      padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; background-color: var(--card-bg); color: var(--text-color);
    }
    .payment-input-group button { background-color: var(--main-color); color: white; cursor: pointer; transition: background-color 0.3s; }
    .payment-input-group button:hover { background-color: var(--main-dark); }
    .input-item { flex: 1 1 180px; }
    .input-item label { display: block; margin-bottom: 5px; font-weight: bold; }
    .toggle-container { text-align: center; margin-bottom: 20px; }
    .toggle-btn { padding: 10px 15px; background-color: var(--secondary-color); color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
    .toggle-btn:hover { background-color: #5a6268; }
    footer { text-align: center; padding: 15px; margin-top: 20px; font-size: 0.9em; color: var(--secondary-color); }
    .rights-buttons button { background-color: transparent; color: var(--main-dark); border: 1px solid var(--main-dark); padding: 8px 12px; margin: 5px; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
    .rights-buttons button:hover { background-color: var(--main-color); color: white; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ—“ï¸ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø¯ÙˆØ§Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© ğŸ“</h1>
    <p>Ù…ØªØ§Ø¨Ø¹Ø© Ø¯ÙˆØ§Ù… Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø­Ø¯ØŒ Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†ØŒ Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ØŒ ÙˆØ§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ â€” Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ©</p>
  </header>

  <main>
    <div class="toggle-container">
      <button class="dark-mode" onclick="toggleDarkMode()">DARKLL</button>
    </div>

    <h2>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø¹Ø§Ù…</h2>
    <div class="dashboard">
      <div class="stat-card">
        <h3>Ø¯ÙˆØ§Ù… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
        <p id="monthly-attendance">0 ÙŠÙˆÙ…</p>
      </div>
      <div class="stat-card">
        <h3>Ø¯ÙˆØ§Ù… Ø§Ù„Ø³Ù†Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h3>
        <p id="yearly-attendance">0 ÙŠÙˆÙ…</p>
      </div>
    </div>

    <section class="attendance-section">
      <h2>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h2>
      <div class="table-container">
        <table id="attendance-table">
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„ÙŠÙˆÙ…</th>
              <th>Ø§Ù„Ø°Ù‡Ø§Ø¨ (ØµØ­ âœ”ï¸)</th>
              <th>Ø§Ù„Ø±Ø¬ÙˆØ¹ (ØµØ­ âœ”ï¸)</th>
              <th>Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </section>

    <hr>

  <section class="payment-section">
      <h2>ğŸ’¸ ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (Ø§Ù„Ø£Ù‚Ø³Ø§Ø·/Ø§Ù„Ø±Ø³ÙˆÙ…)</h2>
      <div class="payment-input-group">
        <div class="input-item">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹:</label>
          <input type="date" id="payment-date">
        </div>
        <div class="input-item">
          <label>Ø§Ù„Ø´Ù‡Ø±:</label>
          <select id="payment-month">
            <option disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±</option>
            <option>ØªØ´Ø±ÙŠÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
            <option>ÙƒØ§Ù†ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„</option>
            <option>ÙƒØ§Ù†ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
            <option>Ø´Ø¨Ø§Ø·</option>
            <option>Ø¢Ø°Ø§Ø±</option>
            <option>Ù†ÙŠØ³Ø§Ù†</option>
            <option>Ø£ÙŠØ§Ø±</option>
            <option>Ø­Ø²ÙŠØ±Ø§Ù†</option>
          </select>
        </div>
        <div class="input-item">
          <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø¹):</label>
          <input type="number" id="payment-amount">
        </div>
        <button id="add-payment">Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹</button>
      </div>
      <table id="payment-table">
        <thead>
          <tr>
            <th>Ø§Ù„Ø´Ù‡Ø±</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer>
    <p>âœ”ï¸ Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù‘Ù†Ø© ØªØ¹Ù…Ù„ Ù…Ø¹ Firebase + Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ + Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</p>
  </footer>
  <!-- Firebase + App JS -->
  <script type="module">
    // === Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆÙ†ÙÙŠØº Ø¨Ø§Ù„ÙƒÙˆÙ†ÙÙŠØº Ø¹Ù†Ø¯Ùƒ Ù„Ùˆ Ø§Ø­ØªØ¬Øª ØªØºÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ ===
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      push,
      onValue,
      update,
      remove,
      child,
      get
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCFt-2b4p-ZNipxdREf3QsNIpovDbhwnHw",
      authDomain: "ali22-603de.firebaseapp.com",
      projectId: "ali22-603de",
      storageBucket: "ali22-603de.firebasestorage.app",
      messagingSenderId: "890888190886",
      appId: "1:890888190886:web:1cb51381769a0a20752d67",
      measurementId: "G-T3BYJVDD4N"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    // ------------- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ----------------
    const START_DATE = new Date('2025-11-16T00:00:00');
    const END_DATE = new Date(START_DATE);
    END_DATE.setFullYear(START_DATE.getFullYear() + 1);

    const WEEK_DAYS = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
    const WORK_DAYS_INDICES = [0, 1, 2, 3]; // Ø§Ù„Ø£Ø­Ø¯-Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡

    const attendanceBody = document.querySelector('#attendance-table tbody');
    const paymentBody = document.querySelector('#payment-table tbody');

    let attendanceCache = {}; // Ø³ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø­Ø¶ÙˆØ±
    let paymentsCache = [];   // Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª

    // ------------------ Ø§Ù„Ø«ÙŠÙ… -----------------------
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDarkMode = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDarkMode);
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù…Ø´ Ø¶Ø±ÙˆØ±ÙŠ Ù„ÙƒÙ† Ù†Ø­ØªÙØ¸ Ø¹Ù„ÙŠÙ‡Ø§)
    }
    function applySavedTheme() {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    }

    // ------------------ ØªÙˆØ§Ø±ÙŠØ® ÙˆØªÙ†Ø³ÙŠÙ‚ ----------------
    function formatDateForDisplay(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      // Ù†Ø¹Ø±Ø¶ Ø¨ØµÙŠØºØ© YYYY/MM/DD
      return `${y}/${m}/${d}`;
    }
    function formatDateForKey(date) {
      // Ù…ÙØªØ§Ø­ ØµØ§Ù„Ø­ Ù„Ù„Ù€ Firebase (Ù„Ø§ ÙŠØ­ØªÙˆÙŠ '/')
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`; // YYYY-MM-DD
    }

    // ------------------ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ----------------
    function createAttendanceTable() {
      let currentDate = new Date(START_DATE);
      attendanceBody.innerHTML = '';

      while (currentDate < END_DATE) {
        const dayIndex = currentDate.getDay();

        if (WORK_DAYS_INDICES.includes(dayIndex)) {
          const dateDisplay = formatDateForDisplay(currentDate);
          const dateKey = formatDateForKey(currentDate); // Ù…ÙØªØ§Ø­ Ø¨Ø¯ÙˆÙ† '/'
          const dayName = WEEK_DAYS[dayIndex];

          const row = attendanceBody.insertRow();
          row.id = `day-${dateKey}`; // ex: day-2025-11-16

          row.insertCell().textContent = dateDisplay;
          row.insertCell().textContent = dayName;

          const inCell = row.insertCell();
          const outCell = row.insertCell();

          // Ù†Ø³ØªØ®Ø¯Ù… dataset Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙØªØ§Ø­
          inCell.innerHTML = `<input type="checkbox" data-date="${dateKey}" data-type="in" class="check-in-out" onchange="handleAttendanceChange('${dateKey}')">`;
          outCell.innerHTML = `<input type="checkbox" data-date="${dateKey}" data-type="out" class="check-in-out" onchange="handleAttendanceChange('${dateKey}')">`;

          row.insertCell().className = 'status-cell';
        }

        currentDate.setDate(currentDate.getDate() + 1);
      }
    }

    // ------------------ Ø­ÙØ¸ ÙˆÙ‚Ø±Ø§Ø¡Ø© Ù…Ù† Firebase ----------------
    function saveAttendanceToFirebase(dateKey, data) {
      // data = { in: true/false, out: true/false, timestamp: ... }
      set(ref(db, `attendance/${dateKey}`), data)
        .catch(err => console.error('Firebase save attendance error:', err));
    }

    function addPaymentToFirebase(paymentObject) {
      // Ø¯ÙØ¹ Ø¬Ø¯ÙŠØ¯ -> Ù†Ø³ØªØ®Ø¯Ù… push
      push(ref(db, 'payments'), paymentObject)
        .catch(err => console.error('Firebase add payment error:', err));
    }

    // ------------------ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ----------------
    // Ù†Ø­ØªØ§Ø¬ Ø§Ù„Ø¯Ø§Ù„Ø© Ø£Ù† ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ Ù„Ø£Ù†Ù†Ø§ Ù†Ø³ØªØ¯Ø¹ÙŠÙ‡Ø§ Ù…Ù† onchange ÙÙŠ HTML string
    window.handleAttendanceChange = function(dateKey) {
      const row = document.getElementById(`day-${dateKey}`);
      if (!row) return;

      const checkIn = row.querySelector('[data-type="in"]').checked;
      const checkOut = row.querySelector('[data-type="out"]').checked;

      const payload = {
        in: !!checkIn,
        out: !!checkOut,
        updatedAt: Date.now()
      };

      // Ù†Ø­ÙØ¸ Ù„Ù„Ù…Ø³Ø§Ø± attendance/dateKey
      saveAttendanceToFirebase(dateKey, payload);
      // Ø³ØªÙ‚ÙˆÙ… Ø§Ù„Ù€ listener Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù†Ø§Ø¬Ø­Ø© (onValue)
    }

    // ------------------ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙŠÙˆÙ… ----------------
    function updateDayStatus(row, checkIn, checkOut) {
      const statusCell = row.querySelector('.status-cell');
      statusCell.className = 'status-cell';

      if (checkIn && checkOut) {
        statusCell.textContent = 'âœ”ï¸ Ø¯ÙˆØ§Ù… Ù…ÙƒØªÙ…Ù„';
        statusCell.classList.add('status-completed');
      } else if (checkIn || checkOut) {
        statusCell.textContent = 'âš ï¸ Ù†ØµÙ Ø¯ÙˆØ§Ù…';
        statusCell.classList.add('status-partial');
      } else {
        statusCell.textContent = 'âŒ ØºÙŠØ§Ø¨';
        statusCell.classList.add('status-absent');
      }
    }

    // ------------------ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ----------------
    function updateStatisticsFromCache() {
      let yearlyCompleted = 0;
      let monthlyCompleted = 0;
      const today = new Date();
      const currentMonth = today.getMonth();

      for (const dateKey in attendanceCache) {
        const rec = attendanceCache[dateKey];
        if (rec && rec.in && rec.out) {
          yearlyCompleted++;
          // ØªØ­ÙˆÙŠÙ„ dateKey (YYYY-MM-DD) Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† ØªØ§Ø±ÙŠØ®
          const parts = dateKey.split('-').map(Number);
          const d = new Date(parts[0], parts[1]-1, parts[2]);
          if (d.getMonth() === currentMonth && d.getFullYear() === today.getFullYear()) {
            monthlyCompleted++;
          }
        }
      }

      document.getElementById('monthly-attendance').textContent = `${monthlyCompleted} Ø£ÙŠØ§Ù…`;
      document.getElementById('yearly-attendance').textContent = `${yearlyCompleted} Ø£ÙŠØ§Ù…`;
    }

    // ------------------ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ----------------
    function renderPaymentsFromCache() {
      paymentBody.innerHTML = '';

      if (!paymentsCache || paymentsCache.length === 0) {
        const row = paymentBody.insertRow();
        row.insertCell().colSpan = 4;
        row.cells[0].textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¯ÙØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.';
        row.cells[0].style.textAlign = 'center';
        return;
      }

      paymentsCache.slice().reverse().forEach(payment => {
        const row = paymentBody.insertRow();
        row.classList.add('paid-row');

        row.insertCell().textContent = payment.month || '';
        row.insertCell().textContent = payment.date || '';
        row.insertCell().textContent = `${payment.amount} Ø¯.Ø¹`;
        row.insertCell().textContent = 'âœ… ØªÙ… Ø§Ù„Ø¯ÙØ¹';
      });
    }

    // ------------------ Listeners Ù…Ù† Firebase (Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ©) ----------------
    function listenToAttendanceRealtime() {
      const attendanceRef = ref(db, 'attendance/');
      onValue(attendanceRef, (snapshot) => {
        const val = snapshot.val() || {};
        attendanceCache = val;
        // Ø¹Ø¯Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø­Ø³Ø¨ Ø§Ù„ÙƒØ§Ø´
        // Ù„ÙƒÙ„ ØµÙ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ø­Ø¯Ù‘Ø« checkboxes ÙˆØ§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù‚ÙÙ„
        document.querySelectorAll('#attendance-table tbody tr').forEach(row => {
          const id = row.id; // day-YYYY-MM-DD
          const dateKey = id.replace('day-', '');
          const dayData = attendanceCache[dateKey] || {};
          const checkInEl = row.querySelector('[data-type="in"]');
          const checkOutEl = row.querySelector('[data-type="out"]');

          if (checkInEl) checkInEl.checked = !!dayData.in;
          if (checkOutEl) checkOutEl.checked = !!dayData.out;

          // Ù‚ÙÙ„ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø¥Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ù…Ø±Ù‘ Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡ (Ù…Ø­Ù„ÙŠØ§Ù‹)
          const parts = dateKey.split('-').map(Number);
          const recordDate = new Date(parts[0], parts[1]-1, parts[2]);
          recordDate.setHours(23,59,59,999);
          const today = new Date();
          const isLockedByDate = recordDate < today;

          row.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            if (isLockedByDate) {
              checkbox.disabled = true;
              checkbox.classList.add('locked-checkbox');
            } else {
              checkbox.disabled = false;
              checkbox.classList.remove('locked-checkbox');
            }
          });

          updateDayStatus(row, !!dayData.in, !!dayData.out);
        });

        updateStatisticsFromCache();
      });
    }

    function listenToPaymentsRealtime() {
      const paymentsRef = ref(db, 'payments/');
      onValue(paymentsRef, (snapshot) => {
        const val = snapshot.val() || {};
        // val Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† ÙƒØ§Ø¦Ù† Ù„Ù‡ Ù…ÙØ§ØªÙŠØ­ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© -> Ù†Ø­ÙˆÙ„Ù‡Ø§ Ù„Ù…ØµÙÙˆÙØ©
        paymentsCache = Object.keys(val).map(k => val[k]);
        renderPaymentsFromCache();
      });
    }

    // ------------------ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø© (ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…) ----------------
    function addPayment() {
      const dateInput = document.getElementById('payment-date');
      const monthInput = document.getElementById('payment-month');
      const amountInput = document.getElementById('payment-amount');

      const date = dateInput.value;
      const month = monthInput.value;
      const amount = amountInput.value.trim();

      if (!date || !month || !amount || isNaN(amount) || amount <= 0) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø¯ÙØ¹ØŒ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø®ØµØµØŒ ÙˆÙ…Ø¨Ù„Øº Ø¯ÙØ¹ ØµØ­ÙŠØ­.');
        return;
      }

      const newPayment = {
        date: date,
        month: month,
        amount: new Intl.NumberFormat('ar-IQ').format(amount),
        timestamp: Date.now()
      };

      addPaymentToFirebase(newPayment);
      amountInput.value = '';
    }
     // ğŸ’³ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹
    document.getElementById("add-payment").onclick=()=>{
      let d=document.getElementById("payment-date").value;
      let m=document.getElementById("payment-month").value;
      let a=document.getElementById("payment-amount").value;
      if(!d||!m||!a)return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„");
      push(ref(db,"payments"),{date:d,month:m,amount:a,time:Date.now()});
      document.getElementById("payment-amount").value="";
    }

    // ğŸ“¡ Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
    onValue(ref(db,"payments"),(snap)=>{
      const body=document.querySelector('#payment-table tbody');
      const data=snap.val()||{};
      body.innerHTML="";
      Object.values(data).reverse().forEach(p=>{
        const r=body.insertRow();
        r.insertCell().textContent=p.month;
        r.insertCell().textContent=p.date;
        r.insertCell().textContent=p.amount+" Ø¯.Ø¹";
        r.insertCell().textContent="âœ”ï¸ ØªÙ… Ø§Ù„Ø¯ÙØ¹";
      });
    });

    document.getElementById("payment-date").value=new Date().toISOString().slice(0,10);

    // ------------------ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ----------------
    window.onload = function() {
      applySavedTheme();
      createAttendanceTable();

      // set default date for date input (input[type=date] ÙŠØ­ØªØ§Ø¬ YYYY-MM-DD)
      document.getElementById('payment-date').value = new Date().toISOString().slice(0,10);

      // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ø³Ø§Ø±Ø§Øª ÙÙŠ Firebase (Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ©)
      listenToAttendanceRealtime();
      listenToPaymentsRealtime();
    }
    const darkBtn = document.getElementById("dark-btn");
    darkBtn.onclick = () => {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
    };
    if (localStorage.getItem("darkMode") === "true") document.body.classList.add("dark-mode");
  </script>
</body>
</html>
